define(["utility","userinterface","config"],function(util,ui,conf){return{connection:function(username){console.log("connect"),currentSocket=io(conf.server+conf.port,{"connect timeout":5e3});var that=this;currentSocket.emit("setUsername",username),currentSocket.on(username,function(msg){that.reveiveMessage(msg)}),currentSocket.on("disconnect",function(){currentSocket=null,console.log("disconnect")}),currentSocket.on("connect_failed",function(data){that.closeConnect()}),currentSocket.on("reconnect_failed",function(data){that.closeConnect()}),currentSocket.on("error",function(data){that.closeConnect()}),currentSocket.on("custom_error",function(data){console.log(data.message)}),currentSocket.on("disconnect",function(data){that.closeConnect()}),currentSocket.on("connect_timeout",function(data){that.closeConnect()})},bindSendMessage:function(){var oSendBtn=document.getElementById("send_btn"),that=this;util.isTouchScreen(oSendBtn)?oSendBtn.ontouchstart=that.sendMessage:oSendBtn.onclick=that.sendMessage},sendMessage:function(){var oInput=document.querySelectorAll("#talk_footer input[type=text]")[0],reg=/^\s{0,}$/g,oTalkContentPanel=document.getElementById("talk_content"),from=JSON.parse(localStorage.getItem("currentUser")).name,to=util.strTrim(document.getElementById("user_des").innerText),oContent=oInput.value;if(!reg.test(oContent)){var oSendShowContent="<div class='wrappersend'><p class='send'>"+oInput.value+"</p><span class='sender'>"+from+"</span></div>";oSendShowContent=util.replaceEmotion(oSendShowContent);var data={from:from,to:to,content:oContent+"*"+(new Date).getTime()},oChatCache=JSON.parse(localStorage.getItem(to));if(oChatCache)oChatCache.push(data),localStorage.setItem(to,JSON.stringify(oChatCache));else{var oCache=[];oCache.push(data),localStorage.setItem(to,JSON.stringify(oCache)),ui.addToTalkList(to)}oTalkContentPanel.innerHTML+=oSendShowContent,ui.scrollToBottom(oTalkContentPanel),oInput.value="",ui.toggleFaceRegion(1),currentSocket.emit("chatMessage",data)}},reveiveMessage:function(msg){var oReceiveShowContent="<div class='wrapperreceive'><span class='receiver'>"+msg.from+"</span><p class='receive'>"+msg.content+"</p></div>";oReceiveShowContent=util.replaceEmotion(oReceiveShowContent);var oTalkContent=document.getElementById("talk_content"),oChatCache=JSON.parse(localStorage.getItem(msg.from)),flag=!1;if(oChatCache){var oLastContent=oChatCache[oChatCache.length-1];oLastContent.content!=msg.content&&(oChatCache.push(msg),localStorage.setItem(msg.from,JSON.stringify(oChatCache)),flag=!0)}else{var oCache=[];oCache.push(msg),localStorage.setItem(msg.from,JSON.stringify(oCache)),flag=!0}flag&&(this.isCurrentTalkOpen(msg.from)?(oTalkContent.innerHTML+=oReceiveShowContent,ui.scrollToBottom(oTalkContent)):(this.isTalkItemOpen()||ui.toggleTabNoticification(0),this.isExistsListItem(msg.from)||ui.addToTalkList(msg.from)))},isCurrentTalkOpen:function(username){var oTalkPanel=document.getElementById("talk_panel"),oSpan=document.getElementById("user_des");return util.hasClass(oTalkPanel,"invisible")||oSpan.innerText!=username?!1:!0},isTalkItemOpen:function(){var oUl=document.getElementById("item_ul"),oItem=oUl.getElementsByTagName("li")[0];return util.hasClass(oItem,"item_active")?!0:!1},isExistsListItem:function(username){var oUserPanel=document.getElementById("user_panel"),oLiArr=oUserPanel.getElementsByTagName("li");if(!oLiArr.length)return!1;for(var i=0;i<oLiArr.length;i++)if(-1!=oLiArr[i].innerText.indexOf(username))return!0;return!1},bindEmotionClick:function(){for(var oSpanArr=document.querySelectorAll("#face_ul li span"),oContent=document.querySelector("#talk_footer input[type=text]"),isTouch=util.isTouchScreen(oSpanArr[0]),i=0;i<oSpanArr.length;i++)isTouch?oSpanArr[i].ontouchstart=function(){var emotionId=this.getElementsByTagName("i")[0].className.split("-")[1];oContent.value+="["+emotionId+"]"}:oSpanArr[i].onclick=function(){var emotionId=this.getElementsByTagName("i")[0].className.split("-")[1];oContent.value+="["+emotionId+"]"}},closeConnect:function(){currentSocket&&currentSocket.disconnect()}}});