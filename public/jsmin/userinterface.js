define(["utility","swipe"],function(util,swipe){return{bindItemClick:function(){for(var oUl=document.getElementById("item_ul"),oLiArr=oUl.getElementsByTagName("li"),isTouch=util.isTouchScreen(oLiArr[0]),that=this,i=0;i<oLiArr.length;i++)oLiArr[i].index=i,isTouch?oLiArr[i].ontouchstart=function(){that.setTabItem(this,this.index)}:oLiArr[i].onclick=function(){that.setTabItem(this,this.index)}},bindItemSwipe:function(){var oUser=document.getElementById("user_panel"),oContacts=document.getElementById("contacts"),oSetting=document.getElementById("settings"),oUl=document.getElementById("item_ul"),oLiArr=oUl.getElementsByTagName("li"),that=this;swipe.bind(oUser,{swipeleft:function(){util.removeClass(oContacts,"goback"),util.addClass(oContacts,"goreg"),that.setTabItem(oLiArr[1],1)}}),swipe.bind(oContacts,{swipeleft:function(){util.addClass(oSetting,"goreg"),that.setTabItem(oLiArr[2],2)},swiperight:function(){util.addClass(oUser,"goback"),that.setTabItem(oLiArr[0],0)}}),swipe.bind(oSetting,{swiperight:function(){util.removeClass(oContacts,"goreg"),util.addClass(oContacts,"goback"),that.setTabItem(oLiArr[1],1)}})},bindSearchClose:function(){var oCloseBtn=document.querySelector(".search_back"),that=this;util.isTouchScreen(oCloseBtn)?oCloseBtn.ontouchstart=that.closeSearchPanel:oCloseBtn.onclick=that.closeSearchPanel},setTabItem:function(obj,index){for(var oUl=document.getElementById("item_ul"),oItemArr=oUl.getElementsByTagName("li"),oHead=document.getElementById("tab_head"),isTouch=util.isTouchScreen(oHead),oChatPanel=document.getElementById("chat_panel"),i=0,len=oItemArr.length;len>i;i++)util.removeClass(oItemArr[i],"item_active");var oUlArr=oChatPanel.getElementsByTagName("ul");oUlArr=util.makeDomArray(oUlArr).slice(0,3);for(var i=0,len=oUlArr.length;len>i;i++)util.addClass(oUlArr[i],"hidden");switch(util.addClass(obj,"item_active"),util.removeClass(oUlArr[index],"hidden"),index){case 0:oHead.innerHTML="会话";break;case 1:isTouch?oHead.innerHTML="联系人<span class='search_users' ontouchstart='showSearchPanel();'><i class='fa fa-search'></i></span>":oHead.innerHTML="联系人<span class='search_users' onclick='showSearchPanel();'><i class='fa fa-search'></i></span>";break;case 2:oHead.innerHTML="设置"}toggleTabNoticification(index,1)},initialUserPanel:function(){var oHeader=document.getElementById("logo_uname"),oLogin=document.getElementById("login"),oRegister=document.getElementById("register"),oUserDiv=document.getElementById("user_div"),oSettingUname=document.getElementById("setting_uname"),currentUser=JSON.parse(localStorage.getItem("currentUser"));util.addClass(oLogin,"hidden"),util.addClass(oRegister,"hidden"),util.removeClass(oUserDiv,"hidden"),oHeader.innerText=currentUser.name,oSettingUname.innerText=currentUser.name},showTalkPanel:function(){for(var oContacs=document.getElementById("contacts"),that=this,isTouch=util.isTouchScreen(oContacs),oLiArr1=util.makeDomArray(oContacs.getElementsByTagName("li")),i=0,len=oLiArr1.length;len>i;i++)isTouch?oLiArr1[i].ontouchstart=function(){that.showTalkPanelClick(this.innerText)}:oLiArr1[i].onclick=function(){that.showTalkPanelClick(this.innerText)}},showTalkPanelClick:function(username){var oChatPanel=document.getElementById("chat_panel"),oTalkPanel=document.getElementById("talk_panel"),talkContent=document.getElementById("talk_content"),oSearchPanel=document.getElementById("search_panel"),oSpan=document.getElementById("user_des"),oWidth=document.body.offsetWidth;oSpan.innerText=util.strTrim(username),1024>=oWidth&&util.addClass(oChatPanel,"invisible"),util.addClass(oSearchPanel,"invisible"),talkContent.innerHTML="",talkContent.innerHTML=this.readTalkHistory(username),util.removeClass(oTalkPanel,"invisible"),util.addClass(oTalkPanel,"show_talk_panel"),this.scrollToBottom(talkContent),this.hideUrlBar()},readTalkHistory:function(username){var html="",talkHistory=JSON.parse(localStorage.getItem(username));return util.each(talkHistory,function(item){html+=item.from==username?"<div class='wrapperreceive'><span class='receiver'>"+item.from+"</span><p class='receive'>"+util.replaceEmotion(item.content)+"</p></div>":"<div class='wrappersend'><p class='send'>"+util.replaceEmotion(item.content)+"</p><span class='sender'>"+item.from+"</span></div>"}),html},showSearchPanelClick:function(){for(var oSearchUl=document.getElementById("search_ul"),oLiArr=util.makeDomArray(oSearchUl.getElementsByTagName("li")),isTouch=util.isTouchScreen(oSearchUl),that=this,i=0,len=oLiArr.length;len>i;i++)util.addClass(oLiArr[i],"search_li_show"),isTouch?oLiArr[i].ontouchstart=function(){that.closeSearchPanel(),that.showTalkPanelClick(this.innerText)}:oLiArr[i].onclick=function(){that.closeSearchPanel(),that.showTalkPanelClick(this.innerText)}},showSearchPanel:function(){var oChatPanel=document.getElementById("chat_panel"),oTalkPanel=document.getElementById("talk_panel"),oSearchPanel=document.getElementById("search_panel"),oWidth=document.body.offsetWidth;1024>=oWidth&&(util.addClass(oChatPanel,"invisible"),util.addClass(oTalkPanel,"invisible")),util.removeClass(oSearchPanel,"invisible"),util.addClass(oSearchPanel,"show_talk_panel"),this.hideUrlBar()},bindCloseTalkPanel:function(){var oCloseBtn=document.getElementById("close_btn"),that=this;util.isTouchScreen(oCloseBtn)?oCloseBtn.ontouchstart=that.closeTalkPanel:oCloseBtn.onclick=that.closeTalkPanel},closeTalkPanel:function(){var oChatPanel=document.getElementById("chat_panel"),oTalkPanel=document.getElementById("talk_panel"),oContent=document.querySelector("#talk_footer input[type=text]"),oUl=document.getElementById("face_ul");oContent.value="",util.hasClass(oUl,"hidden")||window.toggleFaceRegion(),util.addClass(oTalkPanel,"invisible"),util.removeClass(oChatPanel,"invisible"),util.addClass(oChatPanel,"show_chat_panel")},closeSearchPanel:function(){var oChatPanel=document.getElementById("chat_panel"),oTalkPanel=document.getElementById("talk_panel"),oSearchPanel=document.getElementById("search_panel"),oSearchUl=document.getElementById("search_ul"),oInput=document.getElementById("search_input");oSearchUl.innerHTML="",oInput.value="",util.addClass(oTalkPanel,"invisible"),util.removeClass(oChatPanel,"invisible"),util.addClass(oSearchPanel,"invisible"),util.addClass(oChatPanel,"show_chat_panel")},removeUserinterface:function(id){for(var oForm=document.getElementById(id),inputs=oForm.getElementsByTagName("input"),i=0,len=inputs.length;len>i;i++)/text|password/.test(inputs[i].type)&&(inputs[i].value="")},initialUser:function(index){var data,html="",userData=[],that=this;0==index?util.sendAjax("post","/getAllUser","",function(xhr){data=JSON.parse(xhr.responseText),data.length&&util.each(data,function(item){item.name!=util.getCurrentUser()&&(html+="<li><img src='img/user.png' class='user_logo'/>"+item.name+"<i class='fa fa-angle-right right-arrow'></i></li>",userData.push(item.name))}),localStorage.setItem("users",JSON.stringify(userData)),window.userData=userData,that.appendContent(html)}):(userData=JSON.parse(localStorage.getItem("users")),window.userData=userData,util.each(userData,function(item){html+="<li><img src='img/user.png' class='user_logo'/>"+item+"<i class='fa fa-angle-right right-arrow'></i></li>"}),this.appendContent(html))},addToTalkList:function(username){var oDescription=document.querySelector(".description"),isTouch=util.isTouchScreen(oDescription),oTabChat=document.getElementById("user_panel");util.addClass(oDescription,"hidden"),oTabChat.innerHTML+=isTouch?"<li ontouchstart=showTalkPanelClick('"+username+"')><img src='img/user.png' class='user_logo'/>"+username+"...<i class='fa fa-angle-right right-arrow'></i></li>":"<li onclick=showTalkPanelClick('"+username+"')><img src='img/user.png' class='user_logo'/>"+username+"...<i class='fa fa-angle-right right-arrow'></i></li>"},appendContent:function(html){var contacts=document.getElementById("contacts");contacts.innerHTML=html,this.showTalkPanel()},appendSearchContent:function(html){var oSearchPanel=document.getElementById("search_ul");oSearchPanel.innerHTML=html,this.showSearchPanelClick()},bindInputChange:function(){var oSearchInput=document.getElementById("search_input"),oSearchPanel=document.getElementById("search_ul"),that=this;oSearchInput.oninput=oSearchInput.onpropertychange=function(){var html="";return""==oSearchInput.value?void(oSearchPanel.innerHTML=""):(util.each(userData,function(item){-1!=item.indexOf(util.strTrim(oSearchInput.value))&&(html+="<li class='search_ul_li'><img src='img/user.png' class='user_logo'/>"+item+"<i class='fa fa-angle-right right-arrow'></i></li>")}),void that.appendSearchContent(html))}},scrollToBottom:function(obj){obj.scrollHeight&&(obj.scrollTop=obj.scrollHeight-obj.offsetHeight)},toggleTabNoticification:function(index,method){var oUl=document.getElementById("item_ul"),oLi=oUl.getElementsByTagName("li")[index],oSpanArr=oLi.getElementsByTagName("span"),oLastSpan=oSpanArr[oSpanArr.length-1];method?(util.addClass(oLastSpan,"hidden"),util.removeClass(oLastSpan,"item_notify")):(util.removeClass(oLastSpan,"hidden"),util.addClass(oLastSpan,"item_notify"))},bindShowEmotion:function(){var oShowBtn=document.getElementById("showEmotion"),that=this;util.isTouchScreen(oShowBtn)?oShowBtn.ontouchstart=function(){that.toggleFaceRegion()}:oShowBtn.onclick=function(){that.toggleFaceRegion()}},toggleFaceRegion:function(index){var oUl=document.getElementById("face_ul"),oFooter=document.getElementById("talk_footer"),oTalkContent=document.getElementById("talk_content"),oWidth=document.body.offsetWidth;if(util.hasClass(oUl,"hidden")){if(index)return;1024>=oWidth?oFooter.style.bottom="180px":oTalkContent.style.height="310px",util.removeClass(oUl,"hidden")}else 1024>=oWidth?oFooter.style.bottom="0px":oTalkContent.style.height="490px",util.addClass(oUl,"hidden")},hideUrlBar:function(){var doc=window.document;if(!window.navigator.standalone&&!location.hash&&window.addEventListener){window.scrollTo(0,1);var scrollTop=1,getScrollTop=function(){return window.pageYOffset||"CSS1Compat"===doc.compatMode&&doc.documentElement.scrollTop||doc.body.scrollTop||0},bodycheck=setInterval(function(){doc.body&&(clearInterval(bodycheck),scrollTop=getScrollTop(),window.scrollTo(0,1===scrollTop?0:1))},15);window.addEventListener("load",function(){setTimeout(function(){getScrollTop()<20&&window.scrollTo(0,1===scrollTop?0:1)},0)},!1)}}}});